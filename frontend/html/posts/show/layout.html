{% extends "layout.html" %}
{% load static %}
{% load posts %}
{% load text_filters %}

{% block title %}
    {% if post.prefix %}{{ post.prefix }} {% endif %}{{ post.title }}{% if post.room %} [{{ post.room.title }}]{% endif %} ‚Äî {{ block.super }}
{% endblock %}

{% block og_tags %}
    <meta property="og:title" content="{% if post.prefix %}{{ post.prefix }} {% endif %}{{ post.title }} ‚Äî {{ settings.APP_NAME }}">
    <meta property="og:site_name" content="{{ settings.APP_NAME }}">
    <meta property="og:url" content="{{ settings.APP_HOST }}{% url "show_post" post.type post.slug %}">
    <meta property="og:type" content="article" />
    <meta property="og:description" content="{% if post.is_public %}{{ post.description | truncatechars:150 }}{% else %}üîí –≠—Ç–æ –∑–∞–∫—Ä—ã—Ç—ã–π –ø–æ—Å—Ç, –¥–æ—Å—Ç—É–ø–Ω—ã–π —Ç–æ–ª—å–∫–æ —á–ª–µ–Ω–∞–º –ö–ª—É–±–∞{% endif %}">
    <meta property="og:image" content="{% og_image post %}">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="{% if post.prefix %}{{ post.prefix }} {% endif %}{{ post.title }} ‚Äî {{ settings.APP_NAME }}">
    <meta name="twitter:description" content="{% if post.is_public %}{{ post.description | truncatechars:150 }}{% else %}üîí –≠—Ç–æ –∑–∞–∫—Ä—ã—Ç—ã–π –ø–æ—Å—Ç, –¥–æ—Å—Ç—É–ø–Ω—ã–π —Ç–æ–ª—å–∫–æ —á–ª–µ–Ω–∞–º –ö–ª—É–±–∞{% endif %}">
    <meta name="twitter:image" content="{% og_image post %}">
{% endblock %}

{% block content %}
    {% block post %}
        <div class="content h-entry">
            {{ post }}
        </div>
    {% endblock %}

    {% block pre_comments %}
        {% if linked_posts %}
            {% include "posts/widgets/linked_posts.html" %}
        {% endif %}
    {% endblock %}

    <div class="content">
        {% block comments %}
            <div class="post-comments" id="comments">
                <div class="comment-scroll-arrow-wrapper">
                    <comment-scroll-arrow />
                </div>

                <div class="post-comments-title" id="post-comments-title">
                    <div class="post-comments-title-left">
                        {% if post.comment_count > 0 %}
                            <a href="#comments" class="post-comments-count">
                                {{ post.comment_count }}  {{ post.comment_count | rupluralize:"–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π,–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è,–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤" }} üëá
                            </a>

                            <form action=".#comments" method="get" class="post-comments-order">
                                <select name="comment_order" onchange="this.form.submit()">
                                    <option value="-upvotes" {% if comment_order == "-upvotes" %}selected{% endif %}>–ø–æ –∫—Ä—É—Ç–æ—Å—Ç–∏</option>
                                    <option value="-created_at" {% if comment_order == "-created_at" %}selected{% endif %}>–ø–æ —Å–≤–µ–∂–µ—Å—Ç–∏</option>
                                    <option value="created_at" {% if comment_order == "created_at" %}selected{% endif %}>–ø–æ –ø–æ—Ä—è–¥–∫—É</option>
                                </select>
                            </form>
                        {% elif post.is_commentable %}
                            <a href="#comments" class="post-comments-count">
                                –û—Ç–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –ø–µ—Ä–≤—ã–º üëá
                            </a>
                        {% endif %}
                    </div>

                    <div class="post-comments-title-left">
                        {% if me and me.is_active_membership %}
                            <post-subscription
                                url="{% url "toggle_post_subscription" post.slug %}"
                                {% if subscription %}is-active-by-default{% endif %}
                                class="post-comments-subscription"
                            >
                                –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
                            </post-subscription>
                        {% endif %}
                    </div>
                </div>

                {% if comments %}
                    {% if post.is_commentable and me %}
                        <reply-form
                            :reply-to="replyTo"
                            comment-order="{{ comment_order }}"
                            avatar-url="{{ me.get_avatar }}"
                            username="{{ me.full_name }}"
                            create-comment-url="{% url "create_comment" post.slug %}"
                        ></reply-form>
                    {% endif %}

                    <div class="post-comments-list">
                        {% include "comments/list.html" with comments=comments reply_form=reply_form type="normal" muted_user_ids=muted_user_ids %}
                    </div>
                {% endif %}

                {% if me and me.is_active_membership and post.is_commentable and post.is_visible or me.is_moderator %}
                    <div class="post-comments-form" id="post-comments-form">
                        {% include "comments/forms/comment.html" with post=post form=comment_form save_message="–û—Ç–ø—Ä–∞–≤–∏—Ç—å"%}
                    </div>

                    <div class="post-comments-rules">
                        <ul>
                            <li>ü§¨ –ü–æ–º–Ω–∏—Ç–µ, —á—Ç–æ –∑–∞ –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏–µ –¥—Ä—É–≥–∏—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, –ø–∞—Å—Å–∏–≤–Ω—É—é –∞–≥—Ä–µ—Å—Å–∏—é, –Ω–µ–¥—Ä—É–∂–µ–ª—é–±–Ω–æ—Å—Ç—å –∏ –ø—Ä–æ—á–∏–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è <a href="{% url "docs" "about" %}">–ø—Ä–∞–≤–∏–ª —ç—Ç–∏–∫–µ—Ç–∞</a> ‚Äî –±—É–¥–µ—Ç –±–∞–Ω</li>
                            <li>‚òùÔ∏è –ï—Å–ª–∏ –∫—Ç–æ-—Ç–æ –≤–µ–¥—ë—Ç —Å–µ–±—è –ø–ª–æ—Ö–æ ‚Äî —Å–∫–∞–∂–∏—Ç–µ –µ–º—É. –ï—Å–ª–∏ –æ–Ω –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç, –ø–æ–∑–æ–≤–∏—Ç–µ <a href="/user/moderator/">@moderator</a></li>
                            <li>üëÄ –ê–≤—Ç–æ—Ä –ø–æ—Å—Ç–∞ –º–æ–∂–µ—Ç –∏ –¥–æ–ª–∂–µ–Ω –º–æ–¥–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å—Ä–∞—á–∏ –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö</li>
                            <li>ü•∞ –ù–µ –¥—É—à–Ω–∏—Ç–µ, —Ä–∞—Å—Å–ª–∞–±—å—Ç–µ—Å—å –∏ –±—É–¥—å—Ç–µ —Å–ª–∞–¥–∫–∏–º–∏ –ø–∏—Ä–æ–∂–æ—á–∫–∞–º–∏</li>
                            <li>‚úçÔ∏è –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å <a href="https://doka.guide/tools/markdown/" target="_blank">Markdown</a></li>
                        </ul>
                    </div>
                {% endif %}
            </div>
        {% endblock %}

        {% if me and not post.is_commentable %}
            {% include "posts/widgets/not_commentable.html" %}
        {% endif %}

        {% if me and not me.is_active_membership %}
            {% include "posts/widgets/membership_expired.html" %}
        {% endif %}

        {% if not me %}
            {% include "posts/widgets/join_the_club.html" %}
        {% endif %}
    </div>
{% endblock %}
