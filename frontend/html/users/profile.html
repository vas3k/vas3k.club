{% extends "layout.html" %}
{% load static %}
{% load comments %}
{% load posts %}
{% load users %}
{% load text_filters %}
{% load paginator %}

{% block title %}
    {{ user.full_name }} ‚Äî {{ block.super }}
{% endblock %}

{% block feeds %}
    <link rel="alternate" type="application/rss+xml"
          title="–í–∞—Å—Ç—Ä–∏–∫.–ö–ª—É–±: –ü–æ—Å—Ç—ã {{ user.slug }}"
          href="{{ settings.APP_HOST }}{% url "user_rss" user.slug %}" />
‚Äç{% endblock %}

{% block og_tags %}
    <meta property="og:title" content="{{ user.full_name }} ‚Äî {{ settings.APP_NAME }}">
    <meta property="og:site_name" content="{{ settings.APP_NAME }}">
    <meta property="og:url" content="{{ settings.APP_HOST }}{% url "profile" user.slug %}">
    <meta property="og:type" content="website" />
    <meta property="og:description" content="{{ user.position }}{% if user.company %}, {{ user.company }}{% endif %}">
    <meta property="og:image" content="{{ user.get_avatar }}">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="{{ user.full_name }} ‚Äî {{ settings.APP_NAME }}">
    <meta name="twitter:description" content="{{ user.position }}{% if user.company %}, {{ user.company }}{% endif %}">
    <meta name="twitter:image" content="{{ user.get_avatar }}">

    <!-- Exclude profiles from search engines -->
    <meta name="robots" content="noindex">
{% endblock %}

{% block content %}
    <div class="content profile">
        {% if me.id == user.id or me.is_moderator %}
            <div class="profile-user-edit">
                {% if me.is_moderator %}
                    <i class="fas fa-tools"></i>&nbsp;<a href="{% url "admin_profile" user.slug %}">–ê–¥–º–∏–Ω–∫–∞</a>&nbsp;&nbsp;&nbsp;
                {% endif %}
                <i class="fas fa-cog"></i>&nbsp;<a href="{% url "profile_settings" user.slug %}">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è</a>
            </div>
        {% endif %}

        {% include "users/widgets/card.html" with user=user %}

        {% if me.id == user.id %}
            <div class="block profile-statuses">
                <div class="profile-status profile-respect">
                    <span class="profile-status-number">+{{ user.upvotes | cool_number }}</span>
                    <span class="profile-status-text">
                        {% if user.upvotes > 1000 %}
                            –ø–ª—é—Å–∏–∫–æ–≤
                        {% else %}
                            {{ user.upvotes | rupluralize:"–ø–ª—é—Å–∏–∫,–ø–ª—é—Å–∏–∫–∞,–ø–ª—é—Å–∏–∫–æ–≤" }}
                        {% endif %}
                    </span>
                </div>
                <a href="{% url "edit_payments" user.slug %}" class="profile-status">
                    {% if user.membership_days_left < 150 %}
                        <span class="profile-status-number">{% if user.membership_days_left < 10 %}üò±{% else %}üòã{% endif %} {{ user.membership_days_left | ceil | cool_number }}</span>
                        <span class="profile-status-text">{{ user.membership_days_left | ceil | rupluralize:"–¥–µ–Ω—å,–¥–Ω—è,–¥–Ω–µ–π" }}</span>
                    {% elif user.membership_days_left <= 730 %}
                        <span class="profile-status-number">üòé {{ user.membership_days_left | days_to_months | cool_number  }}</span>
                        <span class="profile-status-text">{{ user.membership_days_left | days_to_months | rupluralize:"–º–µ—Å—è—Ü,–º–µ—Å—è—Ü–∞,–º–µ—Å—è—Ü–µ–≤" }}</span>
                    {% else %}
                        <span class="profile-status-number">üíé {{ user.membership_days_left | days_to_years | cool_number }}</span>
                        <span class="profile-status-text">{{ user.membership_days_left | days_to_years | rupluralize:"–≥–æ–¥,–≥–æ–¥–∞,–ª–µ—Ç" }}</span>
                    {% endif %}
                </a>
                <a href="{% url "edit_notifications" user.slug %}" class="profile-status">
                    <span class="profile-status-icon">üíå</span>
                    <span class="profile-status-status">
                        {% if user.is_email_unsubscribed %}
                            –í—ã –æ—Ç–ø–∏—Å–∞–Ω—ã –æ—Ç –≤—Å–µ—Ö –ø–∏—Å–µ–º üôÖ‚Äç‚ôÇÔ∏è
                        {% elif not user.is_email_verified %}
                            –í—ã –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª–∏ e-mail üö®
                        {% else %}
                            {% if user.email_digest_type == "daily" %}
                                –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –¥–∞–π–¥–∂–µ—Å—Ç üî•
                            {% elif user.email_digest_type == "weekly" %}
                                –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –∂—É—Ä–Ω–∞–ª üíé
                            {% else %}
                                –î–∞–π–¥–∂–µ—Å—Ç –∏ –∂—É—Ä–Ω–∞–ª –æ—Ç–∫–ª—é—á—ë–Ω—ã ‚ùå
                            {% endif %}
                        {% endif %}
                    </span>
                </a>
                <a href="{% url "edit_bot" user.slug %}" class="profile-status">
                    <span class="profile-status-icon">ü§ñ</span>
                    <span class="profile-status-status">
                        {% if user.telegram_id %}
                            ‚úÖ –ë–æ—Ç –∞–∫—Ç–∏–≤–µ–Ω
                        {% else %}
                            ‚ùå –ë–æ—Ç –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω
                        {% endif %}
                    </span>
                </a>
            </div>
        {% else %}
            <div class="block profile-statuses">
                <div class="profile-status profile-respect">
                    <span class="profile-status-number">+{{ user.upvotes | cool_number }}</span>
                    <span class="profile-status-text">
                        {% if user.upvotes > 1000 %}
                            –ø–ª—é—Å–∏–∫–æ–≤
                        {% else %}
                            {{ user.upvotes | rupluralize:"–ø–ª—é—Å–∏–∫,–ø–ª—é—Å–∏–∫–∞,–ø–ª—é—Å–∏–∫–æ–≤" }}
                        {% endif %}
                    </span>
                </div>

                <div class="profile-status">
                    {% if user.is_banned %}
                        <span class="profile-status-icon">üëÆ‚Äç‚ôÄÔ∏è</span>
                        <span class="profile-status-text">–∑–∞–±–∞–Ω–µ–Ω</span>
                        {% if user.metadata.last_ban %}
                            <span class="profile-status-text-small">
                                {% if user.metadata.last_ban.days %}
                                    {% if user.metadata.last_ban.days > 999 %}
                                        –Ω–∞–≤–µ—á–Ω–æ
                                    {% else %}
                                        –Ω–∞ {{ user.metadata.last_ban.days }} {{ user.metadata.last_ban.days|rupluralize:"–¥–µ–Ω—å,–¥–Ω—è,–¥–Ω–µ–π" }}
                                    {% endif %}
                                {% endif %}
                                {% if user.metadata.last_ban.reason %}
                                    | {{ user.metadata.last_ban.reason }}
                                {% endif %}
                            </span>
                        {% endif %}
                    {% elif user.deleted_at %}
                        <span class="profile-status-icon">üèÉ‚Äç‚ôÄÔ∏è</span>
                        <span class="profile-status-text">—É–¥–∞–ª–∏–ª—Å—è –∏–∑ –ö–ª—É–±–∞</span>
                    {% elif not user.is_active_member %}
                        <span class="profile-status-icon">Ô∏èüò¥</span>
                        <span class="profile-status-text">–∞–∫–∫–∞—É–Ω—Ç –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω</span>
                    {% else %}
                        {% if user.membership_created_days < 150 %}
                            <span class="profile-status-number">‚è≥ {{ user.membership_created_days | ceil | cool_number }}</span>
                            <span class="profile-status-text">{{ user.membership_created_days | ceil | rupluralize:"–¥–µ–Ω—å,–¥–Ω—è,–¥–Ω–µ–π" }} –≤ –ö–ª—É–±–µ</span>
                        {% elif user.membership_created_days <= 730 %}
                            <span class="profile-status-number">‚è≥ {{ user.membership_created_days | days_to_months | cool_number  }}</span>
                            <span class="profile-status-text">{{ user.membership_created_days | days_to_months | rupluralize:"–º–µ—Å—è—Ü,–º–µ—Å—è—Ü–∞,–º–µ—Å—è—Ü–µ–≤" }} –≤ –ö–ª—É–±–µ</span>
                        {% else %}
                            <span class="profile-status-number">‚è≥ {{ user.membership_created_days | days_to_years | cool_number }}</span>
                            <span class="profile-status-text">{{ user.membership_created_days | days_to_years | rupluralize:"–≥–æ–¥,–≥–æ–¥–∞,–ª–µ—Ç" }} –≤ –ö–ª—É–±–µ</span>
                        {% endif %}
                    {% endif %}
                </div>

                {% if me %}
                    <friend-button
                        url="{% url "toggle_friend" user.slug %}"
                        {% if friend %}is-friend-by-default{% endif %}>
                    </friend-button>
                {% endif %}

                {% if not user.is_curator and not user.is_moderator %}
                    {% if muted %}
                        <a href="{% url "toggle_mute" user.slug %}" class="profile-status clickable">
                            <span class="profile-status-icon">‚ùå</span>
                            <span class="profile-status-status">–°–Ω—è—Ç—å –±–∞–Ω</span>
                        </a>
                    {% else %}
                        <a href="{% url "toggle_mute" user.slug %}" class="profile-status clickable">
                            <span class="profile-status-icon">‚õîÔ∏è</span>
                            <span class="profile-status-status">–Ø –Ω–µ —Ö–æ—á—É –≤–∏–¥–µ—Ç—å —ç—Ç–æ–≥–æ —é–∑–µ—Ä–∞ –≤ –ö–ª—É–±–µ</span>
                        </a>
                    {% endif %}
                {% endif %}
            </div>
        {% endif %}

        {% if badges %}
            <a class="user-badges" href="{% url "profile_badges" user.slug  %}">
                {% include "badges/widgets/badges.html" with badges=badges badge_size="big" %}
            </a>
        {% endif %}

        {% if me %}
            <div class="profile-note {% if note.text or moderator_notes %}profile-note-extended{% endif %}" id="profile-note">
                <label for="profile-note-form-text" class="profile-note-title" onclick="document.getElementById('profile-note').classList.toggle('profile-note-extended');">
                    {% if not note.text %}
                        ‚úèÔ∏è –û—Å—Ç–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É –æ–± —ç—Ç–æ–º —é–∑–µ—Ä–µ
                    {% else %}
                        üìù –í–∞—à–∞ –∑–∞–º–µ—Ç–∫–∞ –æ–± —ç—Ç–æ–º —é–∑–µ—Ä–µ
                    {% endif %}
                </label>

                <form action="{% url "edit_note" user.slug %}" method="post" class="profile-note-form">
                    <textarea name="text" class="profile-note-form-text" id="profile-note-form-text">{{ note.text | default:"" }}</textarea>

                    <button type="submit" class="button button-small profile-note-form-button">
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                    </button>

                    {% if moderator_notes %}
                        {% for moderator_note in moderator_notes %}
                            <div class="profile-note-moderator">
                                <strong>{{ moderator_note.user_from.slug }}</strong>: {{ moderator_note.text }}
                            </div>
                        {% endfor %}
                    {% endif %}

                    {% if not note.text and not moderator_notes %}
                        <div class="profile-note-footer">
                            –ó–∞–º–µ—Ç–∫–∞ –≤–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ –≤–∞–º, —Å–∞–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∏—á–µ–≥–æ –Ω–µ —É–∑–Ω–∞–µ—Ç üòà
                        </div>
                    {% endif %}
                </form>
            </div>
        {% endif %}

        {% if intro %}
            <div class="block profile-intro">
                <div class="profile-header">
                    <a href="{% url "show_post" "intro" intro.slug %}">–ò–Ω—Ç—Ä–æ &rarr;</a>
                    {% if me.id == user.id %}
                        <a href="{% url "edit_post" intro.slug  %}" class="button post-edit-button profile-intro-edit">
                            <i class="fas fa-edit"></i>
                        </a>
                    {% endif %}
                </div>
                <div class="text-body profile-intro-text">
                    {% render_post intro %}
                </div>
                <div class="profile-intro-footer">
                    <a href="{% url "show_post" intro.type intro.slug %}#comments">
                        {{ intro.comment_count }} {{ intro.comment_count | rupluralize:"–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π,–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è,–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤" }}
                    </a>
                </div>
            </div>
        {% endif %}

        {% if projects %}
            <div class="profile-header">–ü—Ä–æ–µ–∫—Ç—ã</div>

            <div class="user-projects">
                {% for project in projects %}
                    <a href="{% url "show_post" project.type project.slug %}" class="block user-project">
                        {% if project.image %}
                            <img src="{{ project.image }}" alt="{{ project.title }}">
                        {% endif %}
                        <span class="user-project-title">{{ project.title }}</span>
                    </a>
                {% endfor %}
            </div>
        {% endif %}

        {% if collectible_tags %}
            <div class="profile-header" id="tags_collectible">–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ–≥–∏</div>
            <div class="block profile-tags">
                <div class="profile-tags-group collectible-tags-group">
                    <div class="user-tags">
                        {% for tag in collectible_tags %}
                            {% if me.id == user.id  %}
                                <user-tag tag-name="{{ tag.name }}"
                                          tag-color="{{ tag.color }}"
                                          class="user-tag"
                                          url="{% url "toggle_tag" tag.code %}"
                                          is-active-by-default
                                ></user-tag>
                            {% else %}
                                <a href="{% url "people" %}?tags={{ tag.code }}" class="user-tag user-tag-active" style="background-color: {{ tag.color  }};">
                                    {{ tag.name }}
                                </a>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>

                <div class="profile-tags-footer">
                    <small>
                        –ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ–≥–∏ –º–æ–∂–Ω–æ –Ω–∞–π—Ç–∏ —Ç–æ–ª—å–∫–æ –≤ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –ø–æ—Å—Ç–∞—Ö –∏ —É—Ç–∞—â–∏—Ç—å –∫ —Å–µ–±–µ –≤ –ø—Ä–æ—Ñ–∏–ª—å.
                        –ò—Ö –Ω–∞–ª–∏—á–∏–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ—Å–æ–±—É—é —É–≤–ª–µ—á—ë–Ω–Ω–æ—Å—Ç—å —Ç–µ–º–æ–π.
                    </small>
                </div>
            </div>
        {% endif %}

        {% if active_tags or me.id == user.id %}
            {% regroup tags by group_display as tag_groups %}
            {% for tag_group in tag_groups %}
                <div class="profile-header" id="tags_{{ tag_group.list.0.group }}">{{ tag_group.grouper }}</div>
                <div class="block profile-tags">
                    <div class="profile-tags-group">
                        <div class="user-tags">
                            {% for tag in tag_group.list %}
                                {% if me.id == user.id  %}
                                    <user-tag tag-name="{{ tag.name }}"
                                              tag-color="{{ tag.color }}"
                                              class="user-tag"
                                              url="{% url "toggle_tag" tag.code %}"
                                              {% if tag.code in active_tags %}is-active-by-default{% endif %}
                                    ></user-tag>
                                {% else %}
                                    {% if tag.code in active_tags %}
                                        <span class="user-tag user-tag-active" style="background-color: {{ tag.color  }};">{{ tag.name }}</span>
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>

                    {% if similarity %}
                        {% if tag_group.list.0.group == "personal" %}
                        <div class="profile-tags-footer">
                            –í—ã –ø–æ—Ö–æ–∂–∏ —Å —ç—Ç–∏–º —á–ª–µ–Ω–æ–º –∫–ª—É–±–∞ –Ω–∞ {{ similarity.personal|floatformat }}%
                        </div>
                        {% elif tag_group.list.0.group == "hobbies" %}
                        <div class="profile-tags-footer">
                            –í–∞—à–∏ —É–≤–ª–µ—á–µ–Ω–∏—è —Å–æ–≤–ø–∞–¥–∞—é—Ç –Ω–∞ {{ similarity.hobbies|floatformat }}%
                        </div>
                        {% endif %}
                    {% endif %}

                    {% if tag_group.list.0.group == "club" %}
                        <div class="profile-tags-footer">
                            {% if user.id == me.id %}
                                <small><br>–î–ª—è –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã—Ö —Ç–µ–≥–æ–≤ —Ç–∏–ø–∞ ¬´–∏—â—É —Ä–∞–±–æ—Ç—É¬ª –∏–ª–∏ ¬´–º–æ–≥—É –Ω–∞—É—á–∏—Ç—å¬ª –Ω–µ –∑–∞–±—É–¥—å—Ç–µ —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –≤ –∏–Ω—Ç—Ä–æ. –≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –¥—Ä—É–≥–∏–º –≤–∞—Å –Ω–∞–π—Ç–∏!</small>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            {% endfor %}
        {% endif %}

        {% if achievements %}
            <div class="profile-header">–ê—á–∏–≤–∫–∏ –æ—Ç –ö–ª—É–±–∞</div>

            <div class="profile-achievements">
                <div class="user-achievements">
                    {% for achievement in achievements %}
                        {% include "achievements/widgets/achievement.html" %}
                    {% endfor %}
                </div>
            </div>
        {% endif %}

        {% if me and comments %}
            <div class="profile-header">
                <a href="{% url "profile_comments" user.slug  %}">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ ({{ comments_total }}) &rarr;</a>
            </div>

            <div class="profile-comments">
                {% for comment in comments %}
                    {% include "comments/types/snippet.html" with comment=comment %}
                {% endfor %}
            </div>

            {% if comments_total > comments|length %}
                <div class="profile-more">
                    <a href="{% url "profile_comments" user.slug  %}" class="button button-inverted">–í—Å–µ {{ comments_total }} {{ comments_total|rupluralize:"–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π,–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è,–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤" }}...</a>
                </div>
            {% endif %}
        {% endif %}

        {% if posts %}
            <div class="profile-header">
                <a href="{% url "profile_posts" user.slug  %}">–ü–æ—Å—Ç—ã ({{ posts_total }}) &rarr;</a>
            </div>

            <div class="profile-posts">
                {% for post in posts %}
                    {% include "posts/items/items.html" %}
                {% endfor %}
            </div>

            {% if posts_total > posts|length %}
                <div class="profile-more">
                    <a href="{% url "profile_posts" user.slug  %}" class="button button-inverted">–í—Å–µ {{ posts_total }} {{ posts_total|rupluralize:"–ø–æ—Å—Ç,–ø–æ—Å—Ç–∞,–ø–æ—Å—Ç–æ–≤" }}...</a>
                </div>
            {% endif %}
        {% endif %}
    </div>
{% endblock %}
