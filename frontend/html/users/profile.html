{% extends "layout.html" %}
{% load static %}
{% load comments %}
{% load posts %}
{% load text_filters %}
{% load paginator %}

{% block title %}
    {{ user.slug }} ‚Äî {{ block.super }}
{% endblock %}

{% block og_tags %}
    <meta property="og:title" content="{{ user.slug }} ‚Äî {{ settings.APP_NAME }}">
    <meta property="og:site_name" content="{{ settings.APP_NAME }}">
    <meta property="og:url" content="{{ settings.APP_HOST }}">
    <meta property="og:type" content="website" />
    <meta property="og:description" content="{{ user.position }}{% if user.company %}, {{ user.company }}{% endif %}">
    <meta property="og:image" content="{% static "images/share.png" %}">

    <meta name="twitter:card" content="summary_image">
    <meta name="twitter:title" content="{{ user.slug }} ‚Äî {{ settings.APP_NAME }}">
    <meta name="twitter:description" content="{{ user.position }}{% if user.company %}, {{ user.company }}{% endif %}">
    <meta name="twitter:image" content="{% static "images/share.png" %}">
{% endblock %}


{% block content %}
    <div class="content profile">
        {% if me.id == user.id or me.is_moderator %}
            <div class="profile-user-edit">
                <a href="{% url "edit_profile" user.slug %}">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</a>
                {% if me.is_moderator %}
                    | <a href="{% url "admin_profile" user.slug %}">–ê–¥–º–∏–Ω–∫–∞</a>
                {% endif %}
            </div>
        {% endif %}

        {% include "users/widgets/card.html" with user=user %}

        {% if me.id == user.id %}
            <div class="block profile-statuses">
                <div class="profile-status profile-respect">
                    <span class="profile-status-number">+{{ user.upvotes | cool_number }}</span>
                    <span class="profile-status-text">
                        {% if user.upvotes > 1000 %}
                            –ø–ª—é—Å–∏–∫–æ–≤
                        {% else %}
                            {{ user.upvotes | rupluralize:"–ø–ª—é—Å–∏–∫,–ø–ª—é—Å–∏–∫–∞,–ø–ª—é—Å–∏–∫–æ–≤" }}
                        {% endif %}
                    </span>
                </div>
                <a href="{% url "edit_payments" user.slug %}" class="profile-status">
                    {% if user.membership_days_left < 730 %}
                        <span class="profile-status-number">{% if user.membership_days_left < 10 %}üí©{% else %}üòé{% endif %} {{ user.membership_days_left | cool_number }}</span>
                        <span class="profile-status-text">{{ user.membership_days_left | rupluralize:"–¥–µ–Ω—å,–¥–Ω—è,–¥–Ω–µ–π" }}</span>
                    {% else %}
                        <span class="profile-status-number">üíé {{ user.membership_years_left | cool_number }}</span>
                        <span class="profile-status-text">{{ user.membership_years_left | rupluralize:"–≥–æ–¥,–≥–æ–¥–∞,–ª–µ—Ç" }}</span>
                    {% endif %}
                </a>
                <a href="{% url "edit_notifications" user.slug %}" class="profile-status">
                    <span class="profile-status-icon">üíå</span>
                    <span class="profile-status-status">
                        {% if user.is_email_unsubscribed %}
                            –í—ã –æ—Ç–ø–∏—Å–∞–Ω—ã –æ—Ç –≤—Å–µ—Ö –ø–∏—Å–µ–º üôÖ‚Äç‚ôÇÔ∏è
                        {% elif not user.is_email_verified %}
                            –í—ã –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª–∏ e-mail üö®
                        {% else %}
                            {% if user.email_digest_type == "daily" %}
                                –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –¥–∞–π–¥–∂–µ—Å—Ç üî•
                            {% elif user.email_digest_type == "weekly" %}
                                –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –∂—É—Ä–Ω–∞–ª üíé
                            {% else %}
                                –î–∞–π–¥–∂–µ—Å—Ç –æ—Ç–∫–ª—é—á—ë–Ω ‚ùå
                            {% endif %}
                        {% endif %}
                    </span>
                </a>
                <a href="{% url "edit_bot" user.slug %}" class="profile-status">
                    <span class="profile-status-icon">ü§ñ</span>
                    <span class="profile-status-status">
                        {% if user.telegram_id %}
                            ‚úÖ –ë–æ—Ç –∞–∫—Ç–∏–≤–µ–Ω
                        {% else %}
                            ‚ùå –ë–æ—Ç –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω
                        {% endif %}
                    </span>
                </a>
            </div>
        {% endif %}

        {% if intro or me.id == user.id %}
            <div class="block profile-intro">
                <div class="profile-header">
                    <a href="{% url "show_post" "intro" intro.slug %}">#intro &rarr;</a>
                    {% if me.id == user.id %}
                        <a href="{% url "edit_post" intro.slug  %}" class="button post-edit-button profile-intro-edit">
                            <i class="fas fa-edit"></i>
                        </a>
                    {% endif %}
                </div>
                {% if intro %}
                    <div class="text-body profile-intro-text">
                        {% render_post intro %}
                    </div>
                {% else %}
                    <div class="profile-add-button">
                        <a href="{% url "compose_type" "intro" %}" class="button profile-intro-create">–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ö–ª—É–±—É –æ —Å–µ–±–µ</a>
                    </div>
                {% endif %}
            </div>
        {% endif %}

        {% if achievements %}
            <div class="profile-achievements">
                <div class="user-achievements">
                    {% for achievement in achievements %}
                        <span class="user-achievement" {% if achievement.style %}style="{{ achievement.style }}"{% endif %}>
                            <span class="user-achievement-wrapper">
                                <img src="{{ achievement.image }}" class="user-badge-image" alt="{{ achievement.code }}">
                                <span class="user-achievement-name">{{ achievement.name }}</span>
                            </span>
                            <span class="user-achievement-popup" {% if achievement.style %}style="{{ achievement.style }}"{% endif %}>{{ achievement.description }}</span>
                        </span>
                    {% endfor %}
                </div>
            </div>
        {% endif %}

        {% if active_tags or me.id == user.id %}
            {% regroup tags by group_display as tag_groups %}
            {% for tag_group in tag_groups %}
                <div class="profile-header" id="tags_{{ tag_group.list.0.group }}">{{ tag_group.grouper }}</div>
                <div class="block profile-tags">
                    <div class="profile-tags-group">
                        <div class="user-tags">
                            {% for tag in tag_group.list %}
                                {% if me.id == user.id  %}
                                    <user-tag :tag="JSON.parse('{{ tag.to_dict | jsonify }}')" class="user-tag" url="{% url "toggle_tag" tag.code %}" {% if tag.code in active_tags %}is-active-by-default{% endif %}></user-tag>
                                {% else %}
                                    {% if tag.code in active_tags %}
                                        <span class="user-tag user-tag-active" style="background-color: {{ tag.color  }};">{{ tag.name }}</span>
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    {% if tag_group.list.0.group == "club" %}
                        <div class="profile-tags-footer">
                            {% if user.contact %}
                                <strong>–î–ª—è —Å–≤—è–∑–∏:</strong> {{ user.contact | urlize }}<br>
                                {% if user.id != me.id %}
                                    <small>–ù–µ –∑–∞–±—É–¥—å—Ç–µ —Å–∫–∞–∑–∞—Ç—å, —á—Ç–æ –≤—ã –∏–∑ –í–∞—Å—Ç—Ä–∏–∫.–ö–ª—É–±–∞</small>
                                {% endif %}
                            {% else %}
                                {% if user.id == me.id %}
                                    <strong>‚ö†Ô∏è –í—ã –Ω–µ —É–∫–∞–∑–∞–ª–∏ –∫–æ–Ω—Ç–∞–∫—Ç –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏.<br><a href="{% url "edit_profile" user.slug %}#id_contact">–°–¥–µ–ª–∞–π—Ç–µ —ç—Ç–æ –∑–¥–µ—Å—å</a></strong>
                                {% endif %}
                            {% endif %}

                            {% if user.id == me.id %}
                                <small><br>–î–ª—è –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã—Ö —Ç–µ–≥–æ–≤ —Ç–∏–ø–∞ ¬´–∏—â—É —Ä–∞–±–æ—Ç—É¬ª –∏–ª–∏ ¬´–º–æ–≥—É –Ω–∞—É—á–∏—Ç—å¬ª –Ω–µ –∑–∞–±—É–¥—å—Ç–µ —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –≤ –∏–Ω—Ç—Ä–æ –∏ —É–∫–∞–∑–∞—Ç—å —Å–≤–æ—é —ç–∫—Å–ø–µ—Ä—Ç–∏–∑—É –Ω–∏–∂–µ. –≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –¥—Ä—É–≥–∏–º –≤–∞—Å –Ω–∞–π—Ç–∏!</small>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            {% endfor %}
        {% endif %}

        {% if expertises or me.id == user.id %}
            <div class="profile-header">–≠–∫—Å–ø–µ—Ä—Ç–∏–∑–∞</div>
            <div class="block profile-expertise">
                {% if expertises %}
                    <div class="profile-expertise-rows" id="expertises">
                        {% for expertise in expertises %}
                            <div class="user-expertise-row" id="expertise-{{ expertise.expertise }}">
                                <div class="user-expertise-row-name">
                                    {{ expertise.name }}
                                    {% if me.id == user.id %}
                                        <a href="{% url "delete_expertise" expertise.expertise %}" class="user-expertise-delete" @click.prevent="deleteExpertise">[x]</a>
                                    {% endif %}
                                </div>
                                <div class="user-expertise-row-bar">
                                    <div class="user-expertise-row-bar-inner" style="width: {{ expertise.value }}%;"></div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
                {% if me.id == user.id %}
                    <span class="button profile-expertise-add-button" @click="shownWindow = 'add-expertise'">
                        –†–∞—Å—Å–∫–∞–∂–∏ —á—Ç–æ —É–º–µ–µ—à—å
                    </span>
                {% endif %}
            </div>
        {% endif %}

        {% if projects or me.id == user.id %}
            <div class="profile-header">–ü—Ä–æ–µ–∫—Ç—ã</div>
            {% if projects %}
                <div class="user-projects">
                    {% for project in projects %}
                        <a href="{% url "show_post" project.type project.slug %}" class="block user-project">
                            {% if project.image %}
                                <img src="{{ project.image }}" alt="{{ project.title }}">
                            {% endif %}
                            <span class="user-project-title">{{ project.title }}</span>
                        </a>
                    {% endfor %}
                </div>
            {% else %}
                <div class="block">
                    <div class="profile-add-button">
                        <a href="{% url "compose_type" "project" %}" class="button">–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –Ω–∞–¥ —á–µ–º —Ä–∞–±–æ—Ç–∞–µ—Ç–µ</a>
                    </div>
                </div>
            {% endif %}
        {% endif %}

        {% if comments %}
            <div class="profile-comments">
                <div class="profile-header">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</div>
                {% for comment in comments %}
                    <div class="block comment comment-layout-normal" id="comment-{{ comment.id }}">
                        <div class="comment-header">
                            <div class="user user-small">
                                <span class="user-avatar">
                                    <span class="avatar" style="background-image: url('{{ comment.author.get_avatar }}');"></span>
                                </span>
                                <span class="user-info">
                                    {{ comment.post.title }}
                                </span>
                                <span class="user-footer">
                                    {{ comment.created_at | date:"j E Y" }}
                                </span>
                            </div>
                        </div>
                        <div class="comment-body">
                            <div class="text-body text-body-type-comment">
                                {% render_comment comment %}
                            </div>
                        </div>
                        <div class="comment-rating">
                            <span class="upvote upvote-type-small">{{ comment.upvotes }}</span>
                        </div>
                        <a class="block-link" href="{% url "show_post" comment.post.type comment.post.slug %}#comment-{{ comment.id }}"></a>
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        {% if posts %}
            <div class="profile-posts">
                <div class="profile-header">–ü–æ—Å—Ç—ã</div>
                {% for post in posts %}
                    {% include "posts/items/items.html" %}
                {% endfor %}

                <div class="feed-paginator">
                    {% paginator posts %}
                </div>
            </div>
        {% endif %}
    </div>

    <user-expertise-window submit-form-action="{% url "add_expertise" %}"
                           :expertise-list="JSON.parse('{{ global_data.expertise | jsonify }}')"
                           v-show="shownWindow === 'add-expertise'"
                           @close-window="shownWindow = null">
    </user-expertise-window>
{% endblock %}
